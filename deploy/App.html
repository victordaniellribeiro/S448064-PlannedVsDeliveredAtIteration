<!DOCTYPE html>
<html>
<head>
    <title>Delta Planned Vs Delivered Based on Iteration</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){var t=this.getContext().getProject().ObjectID,e="",a="";this.iterations=[];var o="",l="";console.log("project: ",t);var i=Ext.create("Ext.form.field.Date",{fieldLabel:"From:",listeners:{select:function(t,a){e=a.toISOString()}}}),n=Ext.create("Ext.form.field.Date",{fieldLabel:"To:",listeners:{select:function(t,e){a=e.toISOString()}}}),r=Ext.create("Rally.ui.combobox.IterationComboBox",{itemId:"iterationComboBox",scope:this,listeners:{ready:function(t){l=t.getRecord().get("ObjectID"),o=t.getRecord().get("Name")},select:function(t,e,a){l=t.getRecord().get("ObjectID"),o=t.getRecord().get("Name")}}}),d=Ext.create("Ext.form.field.Checkbox",{boxLabel:"Include Defects?",name:"defects",inputValue:"defects",margin:"10 10 10 100",id:"defectsCheckBox"}),s=Ext.create("Rally.ui.Button",{text:"Search",margin:"10 10 10 100",scope:this,handler:function(){this._doSearch(e,a,t,o,l)}}),c=Ext.create("Ext.panel.Panel",{layout:"hbox",align:"stretch",padding:5,itemId:"datePanel",items:[{xtype:"panel",flex:1,itemId:"filterPanel"},{xtype:"panel",flex:1,itemId:"tooltipPanel"}]}),m=Ext.create("Ext.panel.Panel",{title:"Summary",layout:{type:"vbox",align:"stretch",padding:5},padding:5,itemId:"summaryPanel"}),p=Ext.create("Ext.panel.Panel",{layout:"hbox",padding:5,itemId:"parentPanel",items:[{xtype:"panel",title:"Stories and Defects at Start Date",flex:1,itemId:"childPanel1"},{xtype:"splitter"},{xtype:"panel",title:"Stories and Defects at End Date",flex:1,itemId:"childPanel2"}]});this.myMask=new Ext.LoadMask({msg:"Please wait...",target:p}),this.add(c),c.down("#filterPanel").add(i),c.down("#filterPanel").add(n),c.down("#filterPanel").add(r),c.down("#filterPanel").add(d),c.down("#filterPanel").add(s),c.down("#tooltipPanel").add({id:"tooltipContent1",padding:5,height:45,overflowX:"auto",overflowY:"auto",html:'<div style= "clear:both"><div style="background-color:#cdf9c2; width:20px; height:20px; margin:5px; float:left;"></div><div style="height:20px; margin:5px; float:left;">Stories and Defects present at start date and at the end date with state <b>Accepted</b> or <b>Ready to Ship</b>.</div></div>'},{id:"tooltipContent2",padding:5,height:45,overflowX:"auto",overflowY:"auto",html:'<div style= "clear:both"><div style="background-color:#c2d7f9; width:20px; height:20px; margin:5px; float:left;"></div><div style="height:20px; margin:5px; float:left;">Stories and Defects absent at the start date and present at end date.</div></div>'},{id:"tooltipContent3",padding:5,height:45,overflowX:"auto",overflowY:"auto",html:'<div style= "clear:both"><div style="background-color:#ffe2e2; width:20px; height:20px; margin:5px; float:left;"></div><div style="height:20px; margin:5px; float:left;">Stories and Defects present at the start date, but absent at end date.</div></div>'}),this.add(m),this.add(p)},_includeDefects:function(){return Ext.getCmp("defectsCheckBox").checked},_doSearch:function(t,e,a,o,l){console.log("parent iteration name: ",o),console.log("looking for:",t,e,a),console.log("Defects: ",this._includeDefects()),""!=t&&""!=e&&(this.myMask.show(),this.iterations=[],Ext.create("Rally.data.wsapi.Store",{model:"Iteration",autoLoad:!0,context:{projectScopeUp:!1,projectScopeDown:!0,project:null},filters:Rally.data.QueryFilter.or([Rally.data.QueryFilter.and([{property:"Project.parent.ObjectID",value:a},{property:"name",value:o}]),Rally.data.QueryFilter.and([{property:"Project.parent.parent.ObjectID",value:a},{property:"name",value:o}])]),listeners:{load:function(o,i,n){if(i.length>0){var r=[];_.each(i,function(t){r.push(t.get("ObjectID"))}),this.iterations=r,console.log("iterations: ",this.iterations)}else console.log("single iteration found, using baseIterationId:",l),this.iterations=[l];var d;d=this._includeDefects()?["HierarchicalRequirement","Defect"]:["HierarchicalRequirement"],this.filtersInit=[{property:"__At",value:t},{property:"_TypeHierarchy",operator:"in",value:d},{property:"_ProjectHierarchy",value:a},{property:"Iteration",operator:"in",value:this.iterations}],this.filtersEnd=[{property:"__At",value:e},{property:"_TypeHierarchy",operator:"in",value:d},{property:"_ProjectHierarchy",value:a},{property:"Iteration",operator:"in",value:this.iterations}],this._loadInitData()},scope:this},fetch:["Description","Name","ObjectID"],limit:1/0}))},_loadInitData:function(){console.log("loading init stories");Ext.create("Rally.data.lookback.SnapshotStore",{fetch:["Name","FormattedID","PlanEstimate","State","ScheduleState","PortfolioItem","Parent","_ValidFrom","_ValidTo","TestCase"],filters:this.filtersInit,limit:1/0,autoLoad:!0,sorters:[{property:"ObjectID",direction:"ASC"}],hydrate:["State","ScheduleState"],listeners:{load:function(t,e,a){console.log("Init Store",t),this.initItems=e,this._loadEndData()},scope:this}})},_loadEndData:function(){console.log("loading end stories");Ext.create("Rally.data.lookback.SnapshotStore",{fetch:["Name","FormattedID","PlanEstimate","State","ScheduleState","PortfolioItem","Parent","_ValidFrom","_ValidTo","TestCase"],filters:this.filtersEnd,limit:1/0,autoLoad:!0,sorters:[{property:"ObjectID",direction:"ASC"}],hydrate:["State","ScheduleState"],listeners:{load:function(t,e,a){this.endItems=e,this._onStoriesLoaded(),this.myMask.hide()},scope:this}})},_onStoriesLoaded:function(){var t,e=[],a=[],o=[],l=[],i=[],n=[];_.each(this.initItems,function(t){var e,a;o.push(t.get("ObjectID")),""!=t.get("PortfolioItem")?e=t.get("PortfolioItem"):""!=t.get("Parent")&&(e=t.get("Parent")),""!=t.get("TestCase")&&(a=t.get("TestCase")),e&&!Ext.Array.contains(i,e)&&i.push(e),a&&!Ext.Array.contains(n,a)&&n.push(a)}),_.each(this.endItems,function(t){var e,a;l.push(t.get("ObjectID")),""!=t.get("PortfolioItem")?e=t.get("PortfolioItem"):""!=t.get("Parent")&&(e=t.get("Parent")),""!=t.get("TestCase")&&(a=t.get("TestCase")),e&&!Ext.Array.contains(i,e)&&i.push(e),a&&!Ext.Array.contains(n,a)&&n.push(a)});var r=this._loadParentNames(i),d=this._loadTestCaseNames(n);Deft.Promise.all([r,d]).then({success:function(i){var n=i[0],r=i[1];_.each(this.endItems,function(t){var e,l,i=t.get("ObjectID"),d=t.get("ScheduleState"),s=!0,c=!1;Ext.Array.contains(o,i)||(s=!1),"Accepted"!=d&&"Ready to Ship"!=d||(c=!0),e=t.get("FormattedID").startsWith("D")?"/defect/"+i:"/userstory/"+i,l=t.get("FormattedID").startsWith("D")?r.get(t.get("TestCase")):n.get(""==t.get("PortfolioItem")?t.get("Parent"):t.get("PortfolioItem")),a.push({_ref:e,Name:t.get("Name"),FormattedID:t.get("FormattedID"),State:t.get("ScheduleState"),Planned:s,Parent:l,Completed:c,PlanEstimate:t.get("PlanEstimate")})},this),_.each(this.initItems,function(a){t=a.get("ObjectID");var o,i=!1;Ext.Array.contains(l,t)||(i=!0),o=a.get("FormattedID").startsWith("D")?r.get(a.get("TestCase")):n.get(""==a.get("PortfolioItem")?a.get("Parent"):a.get("PortfolioItem")),e.push({_ref:"/userstory/"+t,Name:a.get("Name"),FormattedID:a.get("FormattedID"),State:a.get("ScheduleState"),Parent:o,Removed:i,PlanEstimate:a.get("PlanEstimate")})},this);var d=Ext.create("Rally.data.custom.Store",{data:e,pageSize:1e3}),s=Ext.create("Rally.data.custom.Store",{data:a,pageSize:1e3});this._createSummaryData(e,a),this._createInitGrid(d,"#childPanel1"),this._createEndGrid(s,"#childPanel2")},failure:function(t){console.log("error:",t)},scope:this})},_loadParentNames:function(t){var e=new Ext.util.MixedCollection,a=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.artifact.Store",{models:["PortfolioItem/Feature","UserStory"],fetch:["Name"],limit:1/0,context:{projectScopeUp:!1,projectScopeDown:!0,project:null},filters:[{property:"ObjectID",operator:"in",value:t}]}).load({callback:function(t,o,l){l?(_.each(t,function(t){e.add(t.get("ObjectID"),t.get("Name"))}),a.resolve(e)):a.reject("Error loading parents.")}}),a.promise},_loadTestCaseNames:function(t){var e=Ext.create("Deft.Deferred");if(!this._includeDefects())return e.resolve(),e.promise;var a=new Ext.util.MixedCollection;return Ext.create("Rally.data.wsapi.artifact.Store",{models:["TestCase"],fetch:["Name"],limit:1/0,context:{projectScopeUp:!1,projectScopeDown:!0,project:null},filters:[{property:"ObjectID",operator:"in",value:t}]}).load({callback:function(t,o,l){l?(_.each(t,function(t){a.add(t.get("ObjectID"),t.get("Name"))}),e.resolve(a)):e.reject("Error loading testCase names.")}}),e.promise},_createInitGrid:function(t,e){var a=Ext.create("Rally.ui.grid.Grid",{showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,itemId:e+"Grid",store:t,columnCfgs:[{xtype:"templatecolumn",text:"ID #",dataIndex:"FormattedID",tdCls:"x-change-cell",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate")},{text:"Name",dataIndex:"Name",flex:1,tdCls:"x-change-cell"},{text:"Parent",dataIndex:"Parent",flex:1,tdCls:"x-change-cell"},{text:"Plan Estimate",dataIndex:"PlanEstimate",tdCls:"x-change-cell"},{text:"Schedule State",dataIndex:"State",tdCls:"x-change-cell"}],viewConfig:{getRowClass:function(t,e,a,o){if(1==t.get("Removed"))return"attention"}}});this.add(a);var o=this.down(e);o.removeAll(!0),o.add(a)},_createEndGrid:function(t,e){var a=Ext.create("Rally.ui.grid.Grid",{showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,itemId:e+"Grid",id:e+"Grid",store:t,columnCfgs:[{xtype:"templatecolumn",text:"ID #",dataIndex:"FormattedID",tdCls:"x-change-cell",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate")},{text:"Name",dataIndex:"Name",flex:1,tdCls:"x-change-cell"},{text:"Parent",dataIndex:"Parent",flex:1,tdCls:"x-change-cell"},{text:"Plan Estimate",dataIndex:"PlanEstimate",tdCls:"x-change-cell"},{text:"State",dataIndex:"State",tdCls:"x-change-cell"}],viewConfig:{getRowClass:function(t,e,a,o){return 0==t.get("Planned")?"new-feature":1==t.get("Completed")?"completed":void 0}}}),o=this.down(e);o.removeAll(!0),o.add(a)},_createSummaryData:function(t,e){var a=0,o=0,l=0,i=0,n=0,r=0,d=0,s=0,c=0,m=0,p=0,h=0;_.each(t,function(t){a+=1,o+=t.PlanEstimate,t.Removed&&(l+=1,i+=t.PlanEstimate)}),_.each(e,function(t){n+=1,r+=t.PlanEstimate,t.Planned||(d+=1,s+=t.PlanEstimate),"Accepted"!=t.State&&"Done"!=t["Ready to Ship"]||(c+=1,m+=t.PlanEstimate),"Accepted"!=t.State&&"Done"!=t["Ready to Ship"]&&(p+=1,h+=t.PlanEstimate)});var u=[];u.push({totalCount:a,totalEstimate:o,totalCountRemoved:l,totalEstimateRemoved:i,totalCountEnd:n,totalEstimateEnd:r,totalCountAdded:d,totalEstimateAdded:s,totalCountCompleted:c,totalEstimateCompleted:m,totalCountNotCompleted:p,totalEstimateNotCompleted:h});var x=Ext.create("Ext.data.JsonStore",{fields:["totalCount","totalEstimate","totalCountRemoved","totalEstimateRemoved","totalCountEnd","totalEstimateEnd","totalCountAdded","totalEstimateAdded","totalCountCompleted","totalEstimateCompleted","totalCountNotCompleted","totalEstimateNotCompleted"]});x.loadData(u),this._createSummaryGrid(x)},_createSummaryGrid:function(t){var e=Ext.create("Ext.grid.Panel",{store:t,height:85,forceFit:!0,viewConfig:{enableTextSelection:!0},columns:[{text:"Start Items",flex:1,columns:[{text:"Total Count",flex:1,sortable:!1,dataIndex:"totalCount"},{text:"Total Estimate",flex:1,sortable:!1,dataIndex:"totalEstimate"},{text:"Total Count Removed",flex:1,sortable:!1,dataIndex:"totalCountRemoved"},{text:"Total Estimate Removed",flex:1,sortable:!1,dataIndex:"totalEstimateRemoved"}]},{text:"End Items",columns:[{text:"Total Count",flex:1,sortable:!1,dataIndex:"totalCountEnd"},{text:"Total Estimate",flex:1,sortable:!1,dataIndex:"totalEstimateEnd"},{text:"Total Count Added",flex:1,sortable:!1,dataIndex:"totalCountAdded"},{text:"Total Estimate Added",flex:1,sortable:!1,dataIndex:"totalEstimateAdded"},{text:"Total Count Completed",flex:1,sortable:!1,dataIndex:"totalCountCompleted"},{text:"Total Estimate Completed",flex:1,sortable:!1,dataIndex:"totalEstimateCompleted"},{text:"Total Count Not Completed",flex:1,sortable:!1,dataIndex:"totalCountNotCompleted"},{text:"Total Estimate Not Completed",flex:1,sortable:!1,dataIndex:"totalEstimateNotCompleted"}]}]});this.down("#summaryPanel").removeAll(!0),this.down("#summaryPanel").add(e)}});

            Rally.launchApp('CustomApp', {
                name:"Delta Planned Vs Delivered Based on Iteration",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        .attention .x-change-cell{background-color:#ffe2e2 !important;color:#900}.new-feature .x-change-cell{background-color:#c2d7f9 !important;color:#009}.completed .x-change-cell{background-color:#cdf9c2 !important;color:#090}
    </style>
</head>
<body>
</body>
</html>
